%%{init: {'theme':'base', 'themeVariables': {'primaryColor':'#ffffff','primaryTextColor':'#000','primaryBorderColor':'#333','lineColor':'#333','secondaryColor':'#d4edda','tertiaryColor':'#f8d7da','background':'#ffffff','mainBkg':'#ffffff','secondBkg':'#ffffff'}}}%%
sequenceDiagram
    participant U as User
    participant API as Download API
    participant Auth as Auth Service
    participant DB as MongoDB
    participant Audit as Audit Logger
    
    U->>API: GET /downloads/manuscripts/{id}
    API->>Auth: Verify Token
    Auth-->>API: User Info
    
    API->>DB: Get Submission
    DB-->>API: Submission Data
    
    API->>API: Check Permissions
    
    alt Permission Granted
        API->>DB: Retrieve File
        DB-->>API: File Content
        API->>Audit: Log Download
        API-->>U: Stream File
    else Permission Denied
        API-->>U: 403 Forbidden
    end
